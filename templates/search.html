{% extends "layout.html" %}

{% block content %}
<h1>Search</h1>

<div class="uk-margin-small">
    Selected model: <span id="current-model"></span> <a class="uk-button uk-button-text" id="open-selectlm-modal" uk-icon="icon: pencil"></a>
</div>

<div>
    <p>
        <label>
            Search-query
            <input class="uk-input" id="search" name="search" value="Test"/>
        </label>
    </p>

    <p>
        <label>
            Search-interval
            <input class="uk-input" type="number" min="1" max="100" value="10" id="search-interval" name="search-interval"/>
        </label>
    </p>

    <p>
        <label>
            Code
            <textarea class="uk-textarea" rows="10" id="content" name="content">
public class Test {
    public static void main(String[] args) {
    }
}</textarea>
        </label>
    </p>

    <button class="uk-button uk-button-primary" id="submit" type="button">Search</button>

    <h2>Result</h2>
</div>


<div class="entropy-settings">
    <h3 class="uk-margin-small">Options</h3>
    <div>
        <label>
            <input type="checkbox" class="uk-checkbox" id="show-borders"> Token framing
        </label>
    </div>
    <!-- <div>
        <label>
            <input type="checkbox" class="uk-checkbox" id="show-colors"> Use only black color
        </label>
    </div>
    <div>
        <label>
            <input type="checkbox" class="uk-checkbox" id="show-entropies"> Visualize entropies 
        </label>
        <a class="uk-button uk-button-text" id="open-colors" uk-icon="icon: pencil"></a>
    </div> -->
</div>

<div class="uk-flex uk-width-1-1">
    <div class="split" id="one">
        <span>Search text</span>
        <pre id="code" class="show-colors"><span></span></pre>
    </div>
    <div class="split preview" id="two">
        <span>Difference %</span>
        <pre id="diff-entropy"><span></span></pre>
    </div>
    <div class="split" id="three">
        <span>Search</span>
        <pre id="search-entropy"><span></span></pre>
    </div>    
    <div class="split" id="four">
        <span>Original</span>
        <pre id="original-entropy"><span></span></pre>
    </div>  
</div>

{% include 'modal_select_model.html' %}


{% endblock %}

{% block js %}
<script type="text/javascript" src="{{ url_for('static', filename='js/split.min.js') }}"></script>
<script>
    Split(['#one', '#two', '#three', '#four'], {sizes: [55, 15, 15, 15]});
    $('.gutter.gutter-horizontal').addClass('uk-flex uk-flex-middle uk-flex-center').html('<span uk-icon="icon: more-vertical; ratio: 4"></span>');

    $('#show-borders').change(function(e) {
        let checked = $(this).is(':checked');
        if(checked) {
            $('#code').addClass('show-borders')
        } else {
            $('#code').removeClass('show-borders')
        }
    });

    $('#show-colors').change(function(e) {
        let checked = $(this).is(':checked');
        if(checked) {
            $('#code').addClass('show-colors')
        } else {
            $('#code').removeClass('show-colors')
        }
    });

    $('#show-entropies').change(function(e) {
        let checked = $(this).is(':checked');
        if(checked) {
            $('#code').addClass('show-entropies')
        } else {
            $('#code').removeClass('show-entropies')
        }
    });

    let original = $('#original-entropy');
    let search = $('#search-entropy');
    let diff = $('#diff-entropy');
    let code = $('#code');
    let loading = $('#loading');
    let btnSubmit = $('#submit');

    btnSubmit.click(function () {
        loading.show();
        btnSubmit.attr('disabled', 'disabled');
        search.html('<span></span>');
        original.html('<span></span>');
        diff.html('<span></span>');
        code.html('<span></span>');
        let data = {
            extension: ".java",
            languageId: "java",
            content: $('#content').val(),
            search: $('#search').val(),
            searchInterval: parseInt($('#search-interval').val()),
            resetContext: true,
            model: currentModel,
        };

        axios.post('/search', data).then(response => {
            console.log("Got response search.html")
            console.log(response.data);
            // insertLines({target: code, lines: response.data.searchContent});

            let mergedEntropies = [];
            for (let i = 0; i < response.data.originalEntropy.length; i++) {
                console.log("modulo ", i, data.searchInterval, (i % (data.searchInterval + 1)))
                if ((i % (data.searchInterval + 1)) == 0) {
                    mergedEntropies.push({
                        aggregated_result: {bin_entropy: 0},
                        prep_text: ["// Search query"],
                        results: {bin_entropy: [0]},
                        text: "// Search query"
                    });
                    console.log("OVERRIDE index ", i)
                    continue;
                }
                console.log("take index ", i)
                let original = response.data.originalEntropy[i];
                let search = response.data.searchEntropy[i];

                let bin_entropy = [];
                for (let j = 0; j < original.results.bin_entropy.length; j++) {
                    let o = original.results.bin_entropy[j];
                    let s = search.results.bin_entropy[j];
                    bin_entropy.push(o / s);
                }

                mergedEntropies.push({
                    aggregated_result: {bin_entropy: original.aggregated_result.bin_entropy / search.aggregated_result.bin_entropy},
                    prep_text: search.prep_text.slice(0),
                    results: {bin_entropy: bin_entropy},
                    text: search.text,
                });
            }

            console.log("merge", mergedEntropies)

            formatEntropies(mergedEntropies, code, colorMapping);
            insertLines({target: original, lines: response.data.originalEntropy.map(e => e.aggregated_result.bin_entropy.toFixed(5))});
            insertLines({target: search, lines: response.data.searchEntropy.map(e => e.aggregated_result.bin_entropy.toFixed(5))});

            let difference = [];
            for (let i = 0; i < response.data.originalEntropy.length; i++) {
                d = (response.data.originalEntropy[i].aggregated_result.bin_entropy / response.data.searchEntropy[i].aggregated_result.bin_entropy).toFixed(5);
                if (Math.abs(1 - d) > 0.20) {   // de/increase of more than 20%
                    d = `<b>${d}</b>`;
                }
                difference.push(d);
            }
            insertLines({target: diff, lines: difference, escapeHTML: false});
        }).catch(error => {
            console.log(error)
        }).finally(() => {
            loading.hide();
            btnSubmit.removeAttr('disabled');
        });
    });

</script>
{% endblock %}